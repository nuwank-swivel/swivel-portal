# Story 07.02: Booking for Someone Else

- **Status**: Todo
- **Epic**: Booking

## Story

**As a** user,
**I want** to be able to make a desk/seat booking on behalf of another person,
**so that** I can reserve space for teammates who asked me to book for them.

The core booking logic and validation remains the same. When booking for someone else:
- A checkbox labeled `Book for someone else` should appear immediately after the form title.
- If checked, a dropdown (people picker) appears that allows selecting a person from the tenant/Teams user list.
- The booking will be created for the selected person (not the current user).
- Recurring booking options must be disabled in the UI and excluded from the API payload when booking for someone else.

If the selected person does not exist in our application database (they haven't logged in yet), show a clear error message on submit and prevent the booking. Backend validation must also reject bookings for unknown users.

## Acceptance Criteria

1. The booking form shows a checkbox labeled `Book for someone else` immediately after the title.
2. When the checkbox is checked, a people-picker dropdown appears and allows selecting a Teams user from the tenant.
3. Selecting a user populates an internal `bookForUserId` (or similar) value that will be used as the booking owner when submitting the booking.
4. If the selected user is not present in our DB, the frontend shows a descriptive error message like: `Selected user does not have an account in Swivel. Ask them to sign in or contact admin.` The API must also return a 4xx error for the same condition.
5. Recurring booking controls are disabled/greyed-out when `Book for someone else` is checked. The client must not include recurring fields in the booking POST payload in this case.
6. Server-side validation rejects any incoming booking payload that includes recurring bookings combined with a `bookForUserId` that is different from the authenticated user. A clear validation error is returned.
7. Existing booking validation, availability checks, and business rules still apply when booking for another user (capacity, single-booking-per-day constraints, etc.).
8. Unit, integration, and E2E tests cover the new UI flows, API validation, and negative case where the selected person is not in the DB.
9. Documentation and UI copy are updated to explain the feature and any permission requirements (Teams Graph permissions, admin consent if needed).

## Tasks / Subtasks

- [ ] Frontend: add checkbox `Book for someone else` immediately after the form title in `apps/swivel-portal` booking form component.
  - [ ] When checked, show a people-picker dropdown that lists Teams users.
  - [ ] Use Teams People Picker or Microsoft Graph to populate the dropdown (delegated flow or client-side Graph call via backend proxy depending on app consent model).
  - [ ] Store selected user's id/email as `bookForUserId` in the form state.
  - [ ] Disable recurring booking UI when `Book for someone else` is checked; visually indicate why the option is disabled.
  - [ ] Show client-side validation error if selected user not present in DB (after API check), with actionable copy.
  - [ ] Add automated unit tests for the new UI states and validation.

- [ ] Backend/API: update booking endpoint to accept an optional `bookForUserId` field (or `bookForEmail`) and treat it as the booking owner when present.
  - [ ] Validate that `bookForUserId` exists in our users collection; if not, return 400 with a clear error.
  - [ ] Reject any request that contains recurring booking details together with a `bookForUserId` different from the authenticated user (return 422/400 with a helpful message).
  - [ ] Ensure all business rules still apply (availability, single-booking-per-day, permissions).
  - [ ] Add unit and integration tests for the new API behavior and validation paths.

- [ ] DAL: ensure user lookup by Teams id/email is available and efficient. Add or update helper methods used by backend validation.

- [ ] E2E: add tests that cover happy path (book for another existing user) and unhappy path (selected user not in DB) and assert recurring booking is not allowed.

- [ ] Docs: update `docs/` and UI help text describing the feature and any Graph permissions/consent needed for enumerating tenant users.

- [ ] i18n: add UI strings for checkbox label, dropdown placeholder, and error messages.

## Dev Notes

- Prefer using the Microsoft Teams People Picker control when running inside Teams for the best UX. If that control isn't sufficient for tenant-wide search, call Microsoft Graph via the backend using an app or delegated token to list users.
- Permission considerations:
  - To read users across the tenant you may need Graph permission `User.Read.All` or `People.Read` depending on approach; app-level permissions require admin consent. Consider using a backend-proxied search with an app token and proper caching.
- Frontend should treat `bookForUserId` as authoritative owner for the booking entity. Audit logs should record who performed the action and on whose behalf.
- UI/UX: when `Book for someone else` is checked, show a short explanation/help text: `You are creating this booking on behalf of someone else; recurring bookings are not allowed.`
- Accessibility: ensure the people picker is keyboard-accessible and has appropriate ARIA labels.
- Security: verify that only authorized users can create bookings on behalf of others (check RBAC/policy). If the app requires restricting who can book for others, implement a feature flag or role check and update acceptance criteria accordingly.

### Data contract suggestion

Frontend -> POST /api/bookings
{
  "seatId": "...",
  "date": "YYYY-MM-DD",
  "startTime": "HH:mm",
  "endTime": "HH:mm",
  "bookForUserId": "<optional-user-id-from-our-db-or-teams-id>",
  // recurring fields MUST NOT be present when bookForUserId is set
}

Server responses (examples):
- 201 Created — booking created for the selected user
- 400 Bad Request — selected user not found in DB
- 422 Unprocessable Entity — recurring booking not allowed when booking for someone else

## Testing

- Unit tests:
  - Booking form component: toggle checkbox -> people-picker renders; recurring section disabled; form state includes `bookForUserId`.
  - Booking API: validate `bookForUserId` exists, reject recurring payloads with `bookForUserId`.

- Integration tests:
  - Backend DB test that creates a booking for another existing user and verifies owner and audit fields.

- E2E tests (Playwright):
  - Happy path: check `Book for someone else`, pick an existing user, submit booking, assert booking created for the selected user.
  - Negative path: pick a user not in DB (mock), submit and assert descriptive error shown and no booking created.
  - Recurring attempt: with `Book for someone else` checked, try to enable recurring (should be disabled) and assert payload does not include recurring fields.

## Change Log

| Date       | Version | Description                  | Author  |
| ---------- | ------- | ---------------------------- | ------- |
| 2025-10-30 | 0.1     | Initial draft                | Copilot |

## References

- Microsoft Teams JavaScript SDK — People Picker guidance
- Microsoft Graph API — Users: list and search
- Internal booking API design notes (see `docs/prd` and `docs/architecture` for related booking rules)
