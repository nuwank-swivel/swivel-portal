# Story 01.01: Employee Sign-In & Profile Creation

- **Status**: Approved
- **Epic**: User Authentication

## Story

**As an** employee,
**I want** to sign in with my Microsoft 365 account,
**so that** my user profile is automatically created in the system and I can access the portal securely.

## Acceptance Criteria

1.  A "Sign in with Microsoft" button is present on the login page.
2.  Clicking the button initiates the Microsoft 365 OAuth flow.
3.  After successful Microsoft authentication, the frontend sends the received token to a dedicated backend endpoint (e.g., `/auth/login`).
4.  The backend Lambda receives the token, validates it, and checks if a user with the corresponding email exists in the database.
5.  If the user does not exist, a new user record is created in the database.
6.  The backend returns a session token or confirmation to the frontend.
7.  The user is redirected to the main dashboard upon successful login/profile creation.
8.  If authentication or profile creation fails, a clear error message is displayed.

## Tasks / Subtasks

- [ ] **Frontend:**
  - [ ] Install and configure `msal-react` library.
  - [ ] Create a login page component with the "Sign in with Microsoft" button.
  - [ ] Implement the MSAL login function to acquire a token from Azure AD.
  - [ ] After getting the token, send it to the backend `/auth/login` endpoint.
  - [ ] Handle the response from the backend (e.g., store session token, redirect to dashboard).
  - [ ] Implement protected routes that require a valid session.
- [ ] **Backend:**
  - [ ] Create an `/auth/login` API Gateway endpoint with a Lambda integration.
  - [ ] In the login Lambda, validate the incoming JWT from the frontend.
  - [ ] Implement logic to search for the user in the MongoDB `users` collection.
  - [ ] If the user is not found, create a new user document.
  - [ ] Implement a custom Lambda authorizer for all other API endpoints to validate session tokens.

## Dev Notes

- **Authentication Provider:** Azure Active Directory (AAD).
- **Frontend Library:** Use `msal-react` for the OAuth 2.0 flow.
- **Backend Auth:** The primary change is the introduction of a custom Lambda authorizer for securing API endpoints and a specific `/auth/login` Lambda for handling the initial sign-in and user provisioning.
- **Relevant Files:**
  - `apps/swivel-portal/src/app/login/page.tsx` (Login component)
  - `infra/lib/swivel-portal-stack.ts` (for defining the new API Gateway endpoints and Lambda authorizer)

### Testing

- **Unit Tests:**
  - Test the rendering of the login button.
  - Mock the `msal-react` library to test the login flow without a real AAD instance.
- **Integration Tests:**
  - Test the full login flow with a test AAD user.
  - Test that protected API endpoints return a 401 Unauthorized error when no token is provided.

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-10-08 | 1.0     | Initial draft | Bob (SM) |
